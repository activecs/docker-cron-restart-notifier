name: Merge or push to main workflow

on:
  pull_request:
    types: [closed]
    branches: ["main"]
    paths-ignore:
      - 'README.md'
      - '.github/**'

jobs:
  build-test-image:
    name: Build test image
    runs-on: self-hosted
    if: github.event.pull_request.merged == true
    outputs:
      date: ${{ steps.date.outputs.date }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3.4.0
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Build and push test image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: deduard/docker-cron-restart-notifier:test-${{ steps.date.outputs.date }}

  approval:
    name: Wait for approval
    runs-on: ubuntu-latest
    needs: [build-test-image]
    permissions:
      issues: write
    steps:
      - name: Wait for approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: ${{ github.repository_owner }}
          minimum-approvals: 1
          issue-title: "Release approval for docker-cron-restart-notifier"
          issue-body: "Please approve or deny the release. Test image: deduard/docker-cron-restart-notifier:test-${{ needs.build-test-image.outputs.date }}"

  version-and-release:
    name: Version bump and release
    runs-on: self-hosted
    needs: [approval, build-test-image]
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_tag }}
      new_version_major: ${{ steps.bump_version.outputs.part-0 }}
      new_version_minor: ${{ steps.bump_version.outputs.part-0 }}.${{ steps.bump_version.outputs.part-1 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version and push tag
        id: bump_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: patch
          tag_prefix: v
          create_annotated_tag: true

      - name: Update package.json version
        run: |
          VERSION=${{ steps.bump_version.outputs.new_version }}
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" notifier-app/package.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add notifier-app/package.json notifier-app/package-lock.json
          git commit -m "chore: bump version to $VERSION [skip ci]" || echo "No changes to commit"
          git push origin main

  build-release-images:
    name: Build and push release images
    runs-on: self-hosted
    needs: [version-and-release, build-test-image]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.version-and-release.outputs.new_version }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Login
        uses: docker/login-action@v3.4.0
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Build and push to both repos
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            deduard/tools:restart-notifier-${{ needs.build-test-image.outputs.date }}
            deduard/tools:restart-notifier-latest
            deduard/docker-cron-restart-notifier:latest
            deduard/docker-cron-restart-notifier:${{ needs.version-and-release.outputs.new_version }}
            deduard/docker-cron-restart-notifier:${{ needs.version-and-release.outputs.new_version_minor }}
            deduard/docker-cron-restart-notifier:${{ needs.version-and-release.outputs.new_version_major }}

  create-github-release:
    name: Create GitHub Release
    runs-on: self-hosted
    needs: [version-and-release, build-release-images]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.version-and-release.outputs.new_version }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ needs.version-and-release.outputs.new_version }}
          name: Release ${{ needs.version-and-release.outputs.new_version }}
          body: |
            ## Docker Images

            **Old repository (legacy):**
            - `deduard/tools:restart-notifier-${{ needs.build-test-image.outputs.date }}`
            - `deduard/tools:restart-notifier-latest`

            **New repository:**
            - `deduard/docker-cron-restart-notifier:latest`
            - `deduard/docker-cron-restart-notifier:${{ needs.version-and-release.outputs.new_version }}`
            - `deduard/docker-cron-restart-notifier:${{ needs.version-and-release.outputs.new_version_minor }}`
            - `deduard/docker-cron-restart-notifier:${{ needs.version-and-release.outputs.new_version_major }}`
          generate_release_notes: true
